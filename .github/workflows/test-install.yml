name: Test Install Scripts

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to install (leave empty for latest)'
        required: false
        default: ''
      test_i18n:
        description: 'Test i18n (both/zh/en)'
        required: false
        default: 'both'
        type: choice
        options:
          - both
          - zh
          - en

jobs:
  test-unix:
    name: Test Unix (${{ matrix.os }}, ${{ matrix.lang }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        lang: [en, zh]

    steps:
      - uses: actions/checkout@v4

      - name: Set language environment
        run: |
          if [ "${{ matrix.lang }}" = "zh" ]; then
            echo "SHNOTE_LANG=zh_CN.UTF-8" >> $GITHUB_ENV
          else
            echo "SHNOTE_LANG=en_US.UTF-8" >> $GITHUB_ENV
          fi

      - name: Test install script syntax
        run: |
          sh -n scripts/install.sh
          echo "✓ Shell script syntax OK"

      - name: Run actual install
        env:
          SHNOTE_VERSION: ${{ github.event.inputs.version }}
        run: |
          echo "=== Running install (${{ matrix.lang }}) ==="
          sh scripts/install.sh

      - name: Verify installation
        run: |
          echo "=== Verify installation ==="
          ls -la ~/.local/bin/shnote

          # Add to PATH for this step
          export PATH="$HOME/.local/bin:$PATH"

          echo ""
          echo "=== Test shnote ==="
          shnote --version
          shnote --help | head -20

  test-windows:
    name: Test Windows (${{ matrix.lang }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        lang: [en, zh]

    steps:
      - uses: actions/checkout@v4

      - name: Set language environment
        shell: pwsh
        run: |
          if ("${{ matrix.lang }}" -eq "zh") {
            echo "SHNOTE_LANG=zh_CN.UTF-8" >> $env:GITHUB_ENV
          } else {
            echo "SHNOTE_LANG=en_US.UTF-8" >> $env:GITHUB_ENV
          }

      - name: Test install script syntax
        shell: pwsh
        run: |
          $tokens = $null
          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile(
            "$PWD\scripts\install.ps1",
            [ref]$tokens,
            [ref]$errors
          )
          if ($errors.Count -gt 0) {
            Write-Host "Syntax errors found:" -ForegroundColor Red
            $errors | ForEach-Object { Write-Host $_.ToString() }
            exit 1
          }
          Write-Host "✓ PowerShell script syntax OK" -ForegroundColor Green

      - name: Run actual install
        shell: pwsh
        env:
          SHNOTE_VERSION: ${{ github.event.inputs.version }}
        run: |
          Write-Host "=== Running install (${{ matrix.lang }}) ===" -ForegroundColor Cyan
          & "$PWD\scripts\install.ps1"

      - name: Verify installation
        shell: pwsh
        run: |
          Write-Host "=== Verify installation ===" -ForegroundColor Cyan
          $installPath = "$env:USERPROFILE\.local\bin\shnote.exe"
          if (Test-Path $installPath) {
            Write-Host "✓ Binary found at: $installPath" -ForegroundColor Green
            Get-Item $installPath | Select-Object Name, Length, LastWriteTime
          } else {
            Write-Host "✗ Binary not found at: $installPath" -ForegroundColor Red
            exit 1
          }

          Write-Host ""
          Write-Host "=== Verify PATH ===" -ForegroundColor Cyan
          $userPath = [Environment]::GetEnvironmentVariable("Path", "User")
          if ($userPath -like "*\.local\bin*") {
            Write-Host "✓ PATH configured correctly" -ForegroundColor Green
          } else {
            Write-Host "✗ PATH not configured" -ForegroundColor Red
            exit 1
          }

          Write-Host ""
          Write-Host "=== Test shnote ===" -ForegroundColor Cyan
          & $installPath --version
          & $installPath --help | Select-Object -First 20

      - name: Cleanup
        if: always()
        shell: pwsh
        run: |
          $installPath = "$env:USERPROFILE\.local\bin"
          if (Test-Path $installPath) {
            Remove-Item -Recurse -Force $installPath
            Write-Host "Cleaned up $installPath"
          }
          $userPath = [Environment]::GetEnvironmentVariable("Path", "User")
          if ($userPath -like "*\.local\bin*") {
            $newPath = ($userPath -split ';' | Where-Object { $_ -notlike "*\.local\bin*" }) -join ';'
            [Environment]::SetEnvironmentVariable("Path", $newPath, "User")
            Write-Host "Removed from PATH"
          }
